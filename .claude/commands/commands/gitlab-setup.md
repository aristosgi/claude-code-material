---
allowed-tools: mcp__gitlab__*, Bash, Read, Write
argument-hint: [--token <token>] [--url <gitlab-url>] [--global] [--project] [--test]
description: Configure GitLab API integration for any project with automatic detection
---

Configure GitLab API integration for any project with automatic detection.

## Usage
```bash
/gitlab-setup [options]
```

## Arguments
- `--token <token>` - Optional: GitLab API token (will prompt if not provided)
- `--url <gitlab-url>` - Optional: GitLab instance URL (auto-detected from git remote)
- `--global` - Flag: Save to global config (~/.claude/gitlab-config)
- `--project` - Flag: Save to project config (.claude/.gitlab-config)
- `--test` - Flag: Test the configuration after setup

## Examples
```bash
# Auto-setup using git remote detection
/gitlab-setup --token am18LHwBCEso9bGVQYa6

# Setup with custom GitLab URL
/gitlab-setup --token <token> --url https://gitlab.company.com

# Save globally for all projects
/gitlab-setup --token <token> --global

# Test existing configuration
/gitlab-setup --test
```

## Implementation Steps

1. **Parse arguments** - Extract token, flags from command line
2. **Auto-detect GitLab URL** from `git remote get-url origin`
3. **Test API connectivity** with provided token (with retry logic)
4. **CRITICAL: Auto-detect Project ID using EXACT PATH MATCH** (not just project name)
5. **Validate project ID** by making test API call
6. **Generate .gitlab-config** with all detected settings
7. **Secure permissions** - Set 600 on config file
8. **Add to .gitignore** - Ensure config never gets committed

## ⚠️ Critical Issues to Avoid

### Project ID Detection Problems
**Issue:** Using project name search can return wrong project (e.g., "cosmote-testing-lovable-ui" vs "cosmote-testing")

**Solution:** Use exact path matching instead of name search:
```bash
# ❌ WRONG - searches by name only
PROJECT_ID=$(curl ... "$URL/api/v4/projects?search=$PROJECT_NAME")

# ✅ CORRECT - searches by exact path
PROJECT_PATH=$(echo "$REMOTE_URL" | sed 's|\.git$||' | sed 's|.*/\([^/]*/[^/]*\)$|\1|')
PROJECT_ID=$(curl ... "$URL/api/v4/projects?search=$PROJECT_PATH" | \
    grep -B2 -A2 "\"path_with_namespace\":\"$PROJECT_PATH\"" | \
    grep '"id":' | head -1 | grep -o '[0-9]*')
```

### Network Connectivity Issues
**Issue:** Corporate networks may cause intermittent API failures (HTTP 000 responses)

**Solution:** Add retry logic and better error handling:
```bash
# Test connectivity with retries
test_api_connectivity() {
    for i in {1..3}; do
        RESPONSE=$(curl -k -s --connect-timeout 10 --max-time 20 \
            -H "Authorization: Bearer $TOKEN" \
            "$URL/api/v4/version" 2>&1)

        if echo "$RESPONSE" | grep -q '"version"'; then
            echo "✅ API connectivity confirmed"
            return 0
        else
            echo "⚠️ Attempt $i failed: $RESPONSE"
            sleep 2
        fi
    done
    echo "❌ API connectivity failed after 3 attempts"
    return 1
}
```

## Actual Implementation

```bash
# Parse arguments
TOKEN=${args[--token]}
URL=${args[--url]}
TEST_ONLY=${args[--test]}

# Auto-detect from git remote
if [ -z "$URL" ]; then
    REMOTE_URL=$(git remote get-url origin 2>/dev/null)
    URL=$(echo "$REMOTE_URL" | sed 's|^\(https\?://[^/]*\).*|\1|')
    PROJECT_PATH=$(echo "$REMOTE_URL" | sed 's|\.git$||' | sed 's|.*/\([^/]*/[^/]*\)$|\1|')
    PROJECT_NAME=$(echo "$PROJECT_PATH" | sed 's|.*/||')
fi

# Test API and get project ID using exact path
# First try direct access using URL-encoded path
PROJECT_ID=$(curl -k -s -H "Authorization: Bearer $TOKEN" \
    "$URL/api/v4/projects/$(echo "$PROJECT_PATH" | sed 's|/|%2F|g')" | \
    grep -o '"id":[0-9]*' | head -1 | cut -d: -f2)

# If direct access fails, fall back to search with exact path matching
if [ -z "$PROJECT_ID" ]; then
    PROJECT_ID=$(curl -k -s -H "Authorization: Bearer $TOKEN" \
        "$URL/api/v4/projects?search=$PROJECT_PATH" | \
        grep -B2 -A2 "\"path_with_namespace\":\"$PROJECT_PATH\"" | \
        grep '"id":' | head -1 | grep -o '[0-9]*')
fi

# Validate project ID was found
if [ -z "$PROJECT_ID" ]; then
    echo "❌ Could not find project: $PROJECT_PATH"
    echo "   Please check:"
    echo "   - Git remote URL: $REMOTE_URL"
    echo "   - GitLab access token permissions"
    echo "   - Project visibility settings"
    exit 1
fi

# Validate project access
echo "Validating project access..."
PROJECT_VALIDATION=$(curl -k -s -H "Authorization: Bearer $TOKEN" \
    "$URL/api/v4/projects/$PROJECT_ID" | grep '"name"')
if [ -z "$PROJECT_VALIDATION" ]; then
    echo "❌ Cannot access project ID $PROJECT_ID"
    exit 1
fi

# Generate config file
cat > .claude/.gitlab-config << EOF
# GitLab API Configuration for $PROJECT_NAME
# Auto-generated by /gitlab-setup command
GITLAB_TOKEN=$TOKEN
GITLAB_URL=$URL
PROJECT_ID=$PROJECT_ID
PROJECT_NAME=$PROJECT_NAME
PROJECT_PATH=$PROJECT_PATH
# Created: $(date)
EOF

# Configure Git remote with token for authentication
echo "Configuring Git remote with token authentication..."
git remote set-url origin "https://oauth2:$TOKEN@$(echo "$URL" | sed 's|https://||')/$PROJECT_PATH.git"
echo "✅ Git remote configured with token authentication"

# Secure permissions and gitignore
chmod 600 .claude/.gitlab-config
echo ".claude/.gitlab-config" >> .gitignore

echo "✅ GitLab setup complete!"
echo ""
echo "Configuration:"
echo "  Project: $PROJECT_NAME (ID: $PROJECT_ID)"
echo "  Path: $PROJECT_PATH"
echo "  URL: $URL"
echo ""
echo "Config file: .claude/.gitlab-config (permissions: 600)"
echo "Added to .gitignore to prevent accidental commits"
```

## Configuration Priority
1. Project-specific: `.claude/.gitlab-config`
2. Global: `~/.claude/gitlab-config`
3. Environment: `$GITLAB_TOKEN`, `$GITLAB_URL`

## Config File Structure
```bash
# GitLab API Configuration
GITLAB_TOKEN=<token>
GITLAB_URL=<url>
PROJECT_ID=<id>
PROJECT_NAME=<name>
```

## Integration with /mr-review
Once configured, `/mr-review` automatically gains API capabilities:
- `--approve` - Approve the merge request
- `--comment` - Post review results as MR comment
- `--merge` - Merge the MR after successful review